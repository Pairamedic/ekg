<script>
  (function () {
    function initDeck() {
      var deck = document.getElementById('deck');
      if (!deck) return;

      var slides = Array.prototype.slice.call(deck.querySelectorAll('.slide'));
      var progressEls = deck.querySelectorAll('.progress > span');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');
      var overviewBtn = document.getElementById('overviewBtn');
      var blackoutBtn = document.getElementById('blackoutBtn');
      var footers = deck.querySelectorAll('.footer');

      // slide numbers in each footer
      for (var f = 0; f < footers.length; f++) {
        var label = document.createElement('span');
        label.className = 'muted small mono';
        label.style.marginRight = '8px';
        footers[f].insertBefore(label, footers[f].firstChild);
      }

      var i = 0, overview = false, blackout = false;

      function renderSlideNum() {
        var total = slides.length;
        var labels = deck.querySelectorAll('.footer .muted.small.mono');
        for (var k = 0; k < labels.length; k++) {
          labels[k].textContent = (i + 1) + '/' + total;
        }
      }

      function show(idx) {
        i = Math.max(0, Math.min(idx, slides.length - 1));
        for (var n = 0; n < slides.length; n++) {
          var isActive = (n === i);
          if (isActive) slides[n].classList.add('active');
          else slides[n].classList.remove('active');
        }
        var pct = ((i + 1) / slides.length) * 100;
        var rightInset = 100 - pct;
        for (var p = 0; p < progressEls.length; p++) {
          progressEls[p].style.inset = '0 ' + rightInset + '% 0 0';
        }
        location.hash = '#/' + (i + 1);
        renderSlideNum();
      }

      function fromHash() {
        var m = location.hash.match(/#\/(\d+)/);
        if (m) {
          var n = parseInt(m[1], 10);
          if (!isNaN(n)) show(n - 1);
        }
      }

      function toggleOverview() {
        overview = !overview;
        document.body.style.overflow = overview ? 'auto' : 'hidden';
        deck.style.display = overview ? 'grid' : 'block';
        if (overview) {
          deck.style.gridTemplateColumns = 'repeat(auto-fill, minmax(420px, 1fr))';
          deck.style.gap = '16px';
          for (var s = 0; s < slides.length; s++) {
            slides[s].style.position = 'static';
            slides[s].style.opacity = 1;
            slides[s].style.transform = 'none';
            var ftr = slides[s].querySelector('.footer');
            if (ftr && ftr.parentNode) ftr.parentNode.removeChild(ftr);
          }
        } else {
          location.reload();
        }
      }

      function toggleBlackout() {
        blackout = !blackout;
        document.body.style.filter = blackout ? 'brightness(0)' : 'none';
      }

      // Keyboard navigation
      window.addEventListener('keydown', function (e) {
        var key = e.key || e.keyCode;
        if (key === 'ArrowRight' || key === 'PageDown' || key === ' ' || key === 39 || key === 34) {
          e.preventDefault(); show(i + 1);
        }
        if (key === 'ArrowLeft' || key === 'PageUp' || key === 37 || key === 33) {
          e.preventDefault(); show(i - 1);
        }
        if ((key === 'o' || key === 'O' || key === 79)) { toggleOverview(); }
        if ((key === 'b' || key === 'B' || key === 66)) { toggleBlackout(); }
        if ((key === 'h' || key === 'H' || key === 72)) { alert('Keys: ←/→ or Space to navigate, swipe on mobile, O overview, B blackout'); }
      });

      // Click controls
      if (nextBtn) nextBtn.addEventListener('click', function () { show(i + 1); });
      if (prevBtn) prevBtn.addEventListener('click', function () { show(i - 1); });
      if (overviewBtn) overviewBtn.addEventListener('click', toggleOverview);
      if (blackoutBtn) blackoutBtn.addEventListener('click', toggleBlackout);

      // Swipe navigation (mobile)
      var touchStartX = null, touchStartY = null, touching = false;
      var threshold = 50; // px
      deck.addEventListener('touchstart', function (e) {
        var t = e.changedTouches[0];
        touchStartX = t.clientX; touchStartY = t.clientY; touching = true;
      }, { passive: true });
      deck.addEventListener('touchend', function (e) {
        if (!touching) return; touching = false;
        var t = e.changedTouches[0];
        var dx = t.clientX - touchStartX; var dy = t.clientY - touchStartY;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
          if (dx < 0) show(i + 1); else show(i - 1);
        }
      }, { passive: true });

      window.addEventListener('hashchange', fromHash);
      fromHash(); show(i);
    }

    // Ensure the DOM is ready first (max compatibility)
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(initDeck, 0);
    } else {
      window.addEventListener('DOMContentLoaded', initDeck);
    }
  })();
</script>
